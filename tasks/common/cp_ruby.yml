---
- name: Ensure required openssl is installed
  ansible.builtin.command: "{{ rvm_path }} pkg install openssl"
  when:
    - ansible_facts['distribution'] in ["CentOS", "RedHat"] and ansible_facts['distribution_major_version'] >= "9" or
      ansible_facts['distribution'] == "Fedora" and ansible_facts['distribution_major_version'] >= "36"
  tags:
    - ruby

- name: Detect rubies
  command: '{{ rvm_path }} list strings'
  register: rvm_list_strings
  changed_when: False

- name: Ensure correct ruby version is installed
  ansible.builtin.command: "{{ rvm_path }} install {{ ruby_version }} --with-openssl-dir={{ rvm_install_path }}/usr"
  when:
    - ansible_facts['distribution'] in ["CentOS", "RedHat"] and ansible_facts['distribution_major_version'] >= "9" or
      ansible_facts['distribution'] == "Fedora" and ansible_facts['distribution_major_version'] >= "36"
    - not ruby_version in rvm_list_strings.stdout_lines
  tags:
    - ruby

- name: Ensure correct ruby version is installed
  ansible.builtin.command: "{{ rvm_path }} install {{ ruby_version }}"
  when:
    - ansible_facts['distribution'] in ["CentOS", "RedHat"] and ansible_facts['distribution_major_version'] < "9" or
      ansible_facts['distribution'] == "Fedora" and ansible_facts['distribution_major_version'] < "36"
    - not ruby_version in rvm_list_strings.stdout_lines
  tags:
    - ruby

- name: "Install rubygems cli"
  become: true
  ansible.builtin.package:
    name:
      - rubygems
    state: present
  tags:
    - ruby

- name: Ensure bundler is installed
  ansible.builtin.command: "gem install bundler"
  tags:
    - ruby

- name: Ensure correct ruby version is set as default
  ansible.builtin.command: "{{ item }}"
  loop:
    - "{{ rvm_path }} --default use ruby-{{ ruby_version }}"
    - "{{ rvm_path }} alias create default ruby-{{ ruby_version }}"
  tags:
    - ruby